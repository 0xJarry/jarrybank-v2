# Development Plan: Stories 2.2 & 2.3

## Story 2.2: Enhanced Token Discovery & Management

### Objectives
- Automatically discover ALL tokens in connected wallet
- Add custom token support
- Improve token metadata and logos
- Add token search and filtering

### Technical Tasks

#### 1. Token Discovery Service
**File**: `src/lib/tokenDiscovery.ts`
- Use Moralis or Covalent API for comprehensive token scanning
- Fallback to manual contract queries
- Cache discovered tokens per wallet

#### 2. Token Registry
**File**: `src/lib/tokenRegistry.ts`
- Maintain list of known tokens with metadata
- Support custom token addition by contract address
- Store user's custom tokens in localStorage

#### 3. Token Logo Service
**File**: `src/lib/tokenLogos.ts`
- Primary: CoinGecko logos
- Fallback: TrustWallet token list
- Generate identicons for unknown tokens

#### 4. UI Components
**Files to create**:
- `src/components/portfolio/TokenSearch.tsx` - Search/filter tokens
- `src/components/portfolio/AddCustomToken.tsx` - Add token modal
- `src/components/portfolio/TokenLogo.tsx` - Smart logo component

### Implementation Steps
1. Set up token discovery API (Moralis free tier)
2. Create token scanning on wallet connection
3. Build custom token addition flow
4. Implement token search/filter
5. Add proper token logos

### Estimated Time: 2-3 days

---

## Story 2.3: Portfolio Analytics & Insights

### Objectives
- Historical portfolio value tracking
- Performance metrics (ROI, best/worst performers)
- Asset allocation visualization
- Export functionality

### Technical Tasks

#### 1. Historical Data Service
**File**: `src/lib/historicalData.ts`
- Store snapshots of portfolio value over time
- Use IndexedDB for client-side storage
- Calculate performance metrics

#### 2. Analytics Engine
**File**: `src/lib/analytics.ts`
- Calculate ROI, gains/losses
- Identify top performers
- Generate allocation breakdowns

#### 3. Chart Components
**Files to create**:
- `src/components/charts/HistoricalChart.tsx` - Line chart for value over time
- `src/components/charts/AllocationPie.tsx` - Pie chart for asset distribution
- `src/components/charts/PerformanceBar.tsx` - Bar chart for token performance

#### 4. Export Functionality
**File**: `src/lib/exportData.ts`
- Export to CSV format
- Export to JSON format
- Generate PDF reports (optional)

### Implementation Steps
1. Set up IndexedDB for historical data
2. Create snapshot system (runs every hour/day)
3. Build analytics calculations
4. Implement chart components
5. Add export functionality

### Estimated Time: 3-4 days

---

## Shared Infrastructure Needs

### 1. Background Data Updates
**File**: `src/lib/backgroundSync.ts`
- Periodic price updates
- Portfolio snapshot creation
- Use Web Workers for performance

### 2. Enhanced State Management
**File**: `src/store/analyticsStore.ts`
- Historical data state
- Performance metrics state
- User preferences state

### 3. API Rate Limit Management
**File**: `src/lib/rateLimiter.ts`
- Track API usage across providers
- Implement backoff strategies
- Queue requests when hitting limits

---

## Priority Order

### Phase 1 (Story 2.2 Core)
1. Token discovery API integration
2. Custom token addition
3. Token logos
**Time**: 2 days

### Phase 2 (Story 2.3 Core)
1. Historical data storage
2. Basic performance metrics
3. Simple charts
**Time**: 2 days

### Phase 3 (Polish)
1. Advanced analytics
2. Export functionality
3. UI/UX improvements
**Time**: 2 days

---

## Success Criteria

### Story 2.2
- ✅ Discovers 95%+ of wallet tokens automatically
- ✅ Custom token addition in < 3 clicks
- ✅ All tokens have logos (real or generated)
- ✅ Search/filter works instantly

### Story 2.3
- ✅ Shows 7/30/90 day portfolio performance
- ✅ Allocation chart updates in real-time
- ✅ Export to CSV works reliably
- ✅ Historical data persists between sessions

---

## Technical Decisions

### APIs to Use
- **Token Discovery**: Moralis (10,000 requests/month free)
- **Token Metadata**: CoinGecko + TrustWallet list
- **Historical Prices**: CoinGecko (cached aggressively)

### Storage Strategy
- **IndexedDB**: Historical data, snapshots
- **localStorage**: User preferences, custom tokens
- **Memory Cache**: Active session data

### Performance Targets
- Token discovery: < 3 seconds
- Chart rendering: < 500ms
- Export generation: < 2 seconds

---

## Risk Mitigation

### API Limits
- Implement aggressive caching
- Use multiple providers with fallback
- Queue and batch requests

### Data Accuracy
- Validate token contracts before adding
- Cross-reference prices from multiple sources
- Show data freshness indicators

### Browser Storage
- Implement data pruning for old records
- Compress data before storage
- Provide clear storage management UI

---

## Next Steps After 2.2-2.3

1. **DeFi Integration** (Story 3.1)
   - Protocol positions
   - Yield tracking
   - Liquidity pools

2. **Transaction Features** (Story 4.1)
   - Swap integration
   - Transaction history
   - Gas optimization

3. **Advanced Features**
   - Price alerts
   - Portfolio sharing
   - Multi-wallet support